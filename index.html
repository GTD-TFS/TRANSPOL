<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Editor compartido</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e8eefc}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  button{padding:10px 12px;border:1px solid rgba(255,255,255,.14);background:#111a2e;color:#e8eefc;border-radius:10px;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  input{padding:10px 12px;border:1px solid rgba(255,255,255,.14);background:#0f1730;color:#e8eefc;border-radius:10px;outline:none}
  .pill{padding:6px 10px;border:1px solid rgba(255,255,255,.14);border-radius:999px;background:rgba(255,255,255,.06)}
  textarea{width:100%;min-height:62vh;padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:#0f1730;color:#e8eefc;resize:vertical}
  .muted{opacity:.75}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <input id="email" placeholder="email" autocomplete="email" inputmode="email">
    <input id="pass" placeholder="contraseña" type="password" autocomplete="current-password">
    <button id="btnLogin">Entrar</button>
    <button id="btnLogout" disabled>Salir</button>
    <span class="pill" id="who">No autenticado</span>
    <span class="pill muted" id="status">Listo</span>
  </div>

  <div class="bar">
    <button id="btnPaste" disabled>Pegar</button>
    <button id="btnOpenJson" disabled>Abrir JSON</button>
    <input id="fileJson" type="file" accept=".json,application/json" hidden />
    <button id="btnShare" disabled>Compartir/Guardar</button>
  </div>

  <textarea id="editor" placeholder="Pega o escribe aquí..."></textarea>
  <div class="muted" style="margin-top:10px">
    Nota: este ejemplo guarda en <code>notes/{uid}</code> (privado por usuario).
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,
  setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
  const firebaseConfig = {
    apiKey: "AIzaSyA5Bq3HOVvXBkYJBHk18mcdzgqWv-FXidU",
    authDomain: "transpol-ead50.firebaseapp.com",
    projectId: "transpol-ead50",
    storageBucket: "transpol-ead50.firebasestorage.app",
    messagingSenderId: "76597755309",
    appId: "1:76597755309:web:62815e1b8fd3766a81f524"
  };

  const $ = (s)=>document.querySelector(s);
  const email = $("#email"), pass = $("#pass");
  const btnLogin = $("#btnLogin"), btnLogout=$("#btnLogout");
  const btnPaste = $("#btnPaste"), btnOpenJson=$("#btnOpenJson"), btnShare=$("#btnShare");
  const fileJson = $("#fileJson");
  const editor = $("#editor");
  const who = $("#who"), status = $("#status");

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let unsub = null;
  let currentUid = null;

  const setStatus = (t)=> status.textContent = t;

  function setAuthedUI(isAuthed){
    btnLogout.disabled = !isAuthed;
    btnPaste.disabled = !isAuthed;
    btnOpenJson.disabled = !isAuthed;
    btnShare.disabled = !isAuthed;
    btnLogin.disabled = isAuthed;
    email.disabled = isAuthed;
    pass.disabled = isAuthed;
  }

  btnLogin.addEventListener("click", async ()=>{
    try{
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email.value.trim(), pass.value);
    }catch(e){
      console.error(e);
      alert("No se pudo iniciar sesión: " + (e?.message || e));
    }
  });

  btnLogout.addEventListener("click", async ()=>{
    try{ await signOut(auth); }catch(e){ console.error(e); }
  });

  btnPaste.addEventListener("click", async ()=>{
    try{
      const t = await navigator.clipboard.readText();
      editor.value = t ?? "";
      setStatus("Pegado desde portapapeles (sin guardar).");
    }catch{
      alert("El navegador no permitió leer el portapapeles. Prueba Ctrl+V en el editor.");
    }
  });

  btnOpenJson.addEventListener("click", ()=> fileJson.click());
  fileJson.addEventListener("change", async ()=>{
    const f = fileJson.files?.[0];
    fileJson.value = "";
    if(!f) return;
    const txt = await f.text();
    try{
      editor.value = JSON.stringify(JSON.parse(txt), null, 2);
    }catch{
      editor.value = txt;
    }
    setStatus("JSON cargado (sin guardar).");
  });

  btnShare.addEventListener("click", async ()=>{
    if(!currentUid) return;
    try{
      const ref = doc(db, "notes", currentUid);
      await setDoc(ref, {
        text: editor.value,
        updatedAt: serverTimestamp(),
        updatedBy: currentUid
      }, { merge: true });
      setStatus("Guardado y compartido.");
    }catch(e){
      console.error(e);
      alert("No se pudo guardar: " + (e?.message || e));
    }
  });

  onAuthStateChanged(auth, (user)=>{
    if(unsub){ unsub(); unsub=null; }
    currentUid = user?.uid || null;

    if(!user){
      who.textContent = "No autenticado";
      setAuthedUI(false);
      editor.value = "";
      setStatus("Listo");
      return;
    }

    who.textContent = user.email || ("UID: " + user.uid);
    setAuthedUI(true);

    const ref = doc(db, "notes", user.uid);
    unsub = onSnapshot(ref, (snap)=>{
      editor.value = (snap.data()?.text ?? "");
      setStatus("Actualizado desde la nube.");
    }, (err)=>{
      console.error(err);
      setStatus("Error de escucha (mira consola).");
    });
  });
</script>
</body>
</html>