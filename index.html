<!doctype html>
<html lang="es">
<head>
<link rel="icon" href="./icons/icon-192.png">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<link rel="manifest" href="./manifest.webmanifest">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#2563eb">
<title>Editor compartido</title>

<style>
:root{
  --bg:#f4f6f9;
  --card:#ffffff;
  --border:#dcdfe6;
  --text:#1f2937;
  --muted:#6b7280;
  --accent:#2563eb;
}

*{box-sizing:border-box}
[hidden]{display:none !important}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,#eef2f7,#f9fafb);
  color:var(--text);
}

.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:24px;
}

.topbar{
  background:var(--accent);
  border:1px solid rgba(0,0,0,.06);
  border-radius:14px;
  padding:14px 18px;
  display:grid;
  grid-template-columns:1fr auto;
  gap:14px;
  margin-bottom:18px;

  position:sticky;
  top:12px;
  z-index:10;
  box-shadow:0 10px 28px rgba(0,0,0,.06);
}

.auth{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

input{
  padding:11px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:15px;
  min-width:220px;
}

button{
  padding:11px 14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  font-size:15px;
  line-height:1;
  min-height:42px;
  white-space:nowrap;
}

button.primary{
  background-color:var(--accent);
  color:#fff;
  border-color:var(--accent);
  transition: background-color 1s ease;
}

button.primary:hover{
  background-color:#1d4ed8;
}

button:disabled{
  opacity:.45;
  cursor:not-allowed;
}

.status{
  margin-top:6px;
  font-size:13px;
  color:var(--muted);
}

.editor-card{
  background:var(--accent);
  border:1px solid rgba(0,0,0,.06);
  border-radius:16px;
  padding:16px;
  box-shadow:0 10px 28px rgba(0,0,0,.06);
}

.editor-actions{
  margin-top:12px;
  display:flex;
  gap:10px;
  justify-content:flex-end;
  flex-wrap:wrap;
}

.editor-actions button{
  min-width:160px;
}

textarea{
  width:100%;
  background:var(--card);
  min-height:65vh;
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  font-family:ui-monospace,Consolas,monospace;
  font-size:15px;
  line-height:1.5;
  resize:vertical;
}
button.primary{
  transition: background-color 1s ease;
}

#btnShare.flash,
#btnShare.flash:hover{
  background-color:#1d4ed8 !important;
}

@media (max-width: 720px){
  .wrap{ padding:14px; }

  .topbar{
    grid-template-columns:1fr;
    gap:12px;
    padding:12px;
    top:8px;
    border-radius:12px;
  }

  /* Stack auth/actions nicely */
  .auth{ width:100%; }
  .actions{ width:100%; }

  /* Inputs full width */
  #authOut input{
    width:100%;
    min-width:0;
  }

  /* Buttons: 2 columns grid for actions */
  #actions{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  /* Make auth buttons comfortable */
  #authOut button,
  #authIn button{
    width:100%;
  }

  /* Ensure login inputs + button look clean */
  #authOut{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    width:100%;
  }

  #authIn{
    width:100%;
  }

  /* Editor takes space on mobile */
  textarea{ min-height:58vh; }

  .editor-card{ padding:14px; }

  .editor-actions{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    justify-content:stretch;
  }

  .editor-actions button{
    width:100%;
    min-width:0;
  }
}
</style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="auth">
      <div id="authOut" class="auth">
        <input id="email" placeholder="email">
        <input id="pass" type="password" placeholder="contraseña">
        <button id="btnLogin" class="primary">Entrar</button>
      </div>
      <div id="authIn" class="auth" hidden>
        <button id="btnLogout" disabled>Salir</button>
      </div>
    </div>

    <div class="actions" id="actions" hidden>
      <button id="btnOpenJson" disabled>Abrir JSON</button>
      <button id="btnSaveJson" disabled>Guardar JSON</button>
      <input id="fileJson" type="file" accept=".json,application/json" hidden>
    </div>
  </div>

  <div id="appUI" hidden>
    <div class="status">
      <span id="who">No autenticado</span> ·
      <span id="status">Listo</span>
    </div>

    <div class="editor-card">
      <textarea id="editor" placeholder="Texto compartido entre dispositivos…"></textarea>
    </div>

    <div class="editor-actions">
      <button id="btnPaste" disabled>Pegar</button>
      <button id="btnShare" disabled class="primary">Compartir</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,
  setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA5Bq3HOVvXBkYJBHk18mcdzgqWv-FXidU",
  authDomain: "transpol-ead50.firebaseapp.com",
  projectId: "transpol-ead50",
  appId: "1:76597755309:web:62815e1b8fd3766a81f524"
};

const $ = s=>document.querySelector(s);

const email=$("#email"), pass=$("#pass");
const btnLogin=$("#btnLogin"), btnLogout=$("#btnLogout");
const btnPaste=$("#btnPaste"), btnOpenJson=$("#btnOpenJson");
const btnSaveJson=$("#btnSaveJson"), btnShare=$("#btnShare");
const fileJson=$("#fileJson");
const editor=$("#editor");
const who=$("#who"), status=$("#status");
const authOut = $("#authOut");
const authIn  = $("#authIn");
const actions = $("#actions");
const appUI   = $("#appUI");

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentUid=null, unsub=null;

function setStatus(t){ status.textContent=t; }

function setUI(authd){
  // Visibilidad
  if (authOut){
    authOut.hidden = !!authd;
    authOut.style.display = authd ? "none" : "flex";
  }
  if (authIn){
    authIn.hidden = !authd;
    authIn.style.display = authd ? "flex" : "none";
  }
  if (actions) actions.hidden = !authd;
  if (appUI)   appUI.hidden   = !authd;

  // Estado de controles
  btnLogout.disabled = !authd;
  btnPaste.disabled = !authd;
  btnOpenJson.disabled = !authd;
  btnShare.disabled = !authd;

  btnLogin.disabled = authd;
  email.disabled = authd;
  pass.disabled = authd;

  updateJsonBtn();
}

btnLogin.onclick=async()=>{
  await setPersistence(auth,browserLocalPersistence);
  await signInWithEmailAndPassword(auth,email.value.trim(),pass.value);
};

btnLogout.onclick=()=>signOut(auth);

btnPaste.onclick=async()=>{
  editor.value=await navigator.clipboard.readText();
  updateJsonBtn();
};

btnOpenJson.onclick=()=>fileJson.click();
fileJson.onchange=async()=>{
  const f=fileJson.files[0];
  if(!f)return;
  const t=await f.text();
  try{ editor.value=JSON.stringify(JSON.parse(t),null,2); }
  catch{ editor.value=t; }
  updateJsonBtn();
};

btnShare.onclick = async () => {
  btnShare.classList.remove("flash");
  void btnShare.offsetWidth;                 // fuerza reflow (reinicia efecto)
  btnShare.classList.add("flash");
  setTimeout(() => btnShare.classList.remove("flash"), 1000);

  await setDoc(doc(db,"notes",currentUid),{
    text: editor.value,
    updatedAt: serverTimestamp()
  });

  setStatus("Compartido");
};

function isValidJson(){
  try{ JSON.parse(editor.value); return true; }catch{ return false; }
}

function updateJsonBtn(){
  btnSaveJson.disabled=!(currentUid && isValidJson());
}

btnSaveJson.onclick = async () => {
  const data = JSON.parse(editor.value);

  const blob = new Blob(
    [JSON.stringify(data, null, 2)],
    { type: "application/json" }
  );

const suggested = `archivo-${Math.floor(1000 + Math.random() * 9000)}.json`;

  if (window.showSaveFilePicker) {
    const handle = await showSaveFilePicker({
      suggestedName: suggested,
      types: [{
        description: "Archivo JSON",
        accept: { "application/json": [".json"] }
      }]
    });

    const writable = await handle.createWritable();
    await writable.write(blob);
    await writable.close();

  } else {
    // fallback (Safari / Firefox)
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = suggested;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 500);
  }
};

editor.addEventListener("input",updateJsonBtn);

onAuthStateChanged(auth,(user)=>{
  if(unsub){unsub();unsub=null;}
  currentUid=user?.uid||null;

  if(!user){
    if (who) who.textContent = "No autenticado";
    if (editor) editor.value = "";
    setUI(false);
    return;
  }

  who.textContent=user.email;
  setUI(true);

  const ref=doc(db,"notes",user.uid);
  unsub=onSnapshot(ref,s=>{
    editor.value=s.data()?.text||"";
    setStatus("");
    updateJsonBtn();
  });
});
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
</script>
</body>
</html>
